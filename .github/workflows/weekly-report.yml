name: Weekly Report

on:
  schedule:
    # Run every Tuesday at 9:00 AM UTC (adjust timezone as needed)
    - cron: '0 9 * * 2'
  workflow_dispatch:  # Allow manual triggering

jobs:
  weekly-report:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Install dependencies
        run: uv sync

      - name: Create config.yaml from secret
        run: |
          if [ -z "${{ secrets.CONFIG }}" ]; then
            echo "Error: CONFIG secret is not set or is empty"
            exit 1
          fi
          echo "${{ secrets.CONFIG }}" > config.yaml
          if [ ! -s config.yaml ]; then
            echo "Error: config.yaml was created but is empty"
            exit 1
          fi
          echo "✓ config.yaml created successfully"

      - name: Validate secrets
        run: |
          if [ -z "${{ secrets.ESPN_S2 }}" ]; then
            echo "Error: ESPN_S2 secret is not set"
            exit 1
          fi
          if [ -z "${{ secrets.SWID }}" ]; then
            echo "Error: SWID secret is not set"
            exit 1
          fi
          echo "✓ All required secrets are set"

      - name: List all scores
        env:
          ESPN_S2: ${{ secrets.ESPN_S2 }}
          SWID: ${{ secrets.SWID }}
        run: |
          uv run list-scores --start-week=1 --end-week=18 --csv --safe

      - name: List high scores
        env:
          ESPN_S2: ${{ secrets.ESPN_S2 }}
          SWID: ${{ secrets.SWID }}
        run: |
          uv run list-high-scores --start-week=1 --end-week=18 --csv --safe

      - name: List payouts
        env:
          ESPN_S2: ${{ secrets.ESPN_S2 }}
          SWID: ${{ secrets.SWID }}
        run: |
          uv run list-payouts --start-week=1 --end-week=18 --csv --safe

      - name: Upload CSV artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: weekly-reports
          path: |
            scores_weeks_*.csv
            high_scores_weeks_*.csv
            payouts_weeks_*.csv
          retention-days: 30

